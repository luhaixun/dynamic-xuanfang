<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
  <meta charset="UTF-8" />
  <title>选房程序（内部版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22c55e;
      --accent-2: #60a5fa;
      --danger: #ef4444;
      --card: #1f2937;
      --input: #111827;
      --border: #1f2937;
      --results-bg: #0b1220;
      --overlay: rgba(17, 24, 39, 0.65);
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --accent: #16a34a;
      --accent-2: #2563eb;
      --danger: #b91c1c;
      --card: #ffffff;
      --input: #ffffff;
      --border: #e5e7eb;
      --results-bg: #f8fafc;
      --overlay: rgba(0, 0, 0, 0.35);
    }

    html,
    body {
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .title {
      display: flex;
      align-items: baseline;
      gap: 12px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: var(--accent-2);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      color: #fff;
      background-image: radial-gradient(100% 100% at 100% 0, #4f46e5 0, #2563eb 100%);
      cursor: pointer;
      transition: transform .03s ease, box-shadow .15s ease;
      font-weight: 600;
    }

    .btn.secondary {
      background-image: radial-gradient(100% 100% at 100% 0, #22c55e 0, #16a34a 100%);
      border-color: #14532d;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .results {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: var(--results-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      max-height: 420px;
      overflow: auto;
      font-size: 12px;
    }

    .error {
      color: var(--danger);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 16px;
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .results table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .results thead th {
      font-weight: 600;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }

    .results tbody td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
    }

    .results tbody tr:hover {
      background: rgba(96, 165, 250, 0.08);
    }

    .results thead th.sortable {
      cursor: pointer;
    }

    /* Dropdown with checkbox list */
    .dropdown {
      position: relative;
    }

    .dropdown-btn {
      width: 100%;
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      text-align: left;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dropdown-btn:focus {
      border-color: var(--accent-2);
      outline: none;
    }
    /* 仅针对现房小区选择按钮：显示全部所选小区，不省略 */
    #xfDropdown .dropdown-btn {
      width: 100%;          /* 占满容器宽度 */
      display: block;
      white-space: normal;  /* 允许换行，完整显示全部名称 */
      overflow: visible;    /* 不裁剪 */
      text-overflow: clip;  /* 不使用省略号 */
    }

    .dropdown-menu {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      z-index: 1000;
      max-height: 300px;
      overflow: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
    }

    .dropdown-menu .xf-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-bottom: 8px;
    }

    .xf-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 2px;
    }

    .xf-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text);
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent-2);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="container">
    <div class="title">
      <h1>选房程序（内部版）</h1>
      <span class="badge" id="cfg-badge">加载配置...</span>
      <button type="button" class="btn" id="themeToggleBtn" title="切换夜间/白天">切换为白天</button>
    </div>
    <p class="muted">在下方填写参数，然后点击“计算”查看结果。可在结果表右上角导出 Excel。</p>

    <div class="card">
      <form id="solve-form">
        <div class="grid">
          <div>
            <label>目标面积 target（请选择预设或输入）</label>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <label class="badge" style="cursor:pointer;">
                <input type="radio" name="targetChoice" id="targetPreset1" value="" checked />
                <span id="targetPreset1Label">预设1</span>
              </label>
              <label class="badge" style="cursor:pointer;">
                <input type="radio" name="targetChoice" id="targetPreset2" value="" />
                <span id="targetPreset2Label">预设2</span>
              </label>
              <label class="badge" style="cursor:pointer;">
                <input type="radio" name="targetChoice" id="targetCustomRadio" value="custom" />
                自定义
              </label>
              <input id="targetCustom" type="number" step="0.01" placeholder="输入目标面积" style="min-width:160px; display:none;" />
            </div>
          </div>
          <div>
            <label for="giftArea">赠送面积（平）</label>
            <select id="giftArea" name="giftArea">
              <option value="0">0</option>
              <option value="15">15</option>
              <option value="30">30</option>
            </select>
          </div>
          <div>
            <label for="topK">返回数量 topK</label>
            <input id="topK" name="topK" type="number" step="1" min="1" placeholder="默认：10" />
          </div>
          <div>
            <label for="source">来源 source</label>
            <select id="source" name="source">
              <option value="AB">AB（默认）</option>
              <option value="A">仅 A</option>
              <option value="B">仅 B</option>
            </select>
          </div>
          <div>
            <label for="minArea">最小面积 minArea</label>
            <input id="minArea" name="minArea" type="number" step="0.01" placeholder="可留空" />
          </div>
          <div>
            <label for="qfMaxArea">期房最大面积</label>
            <input id="qfMaxArea" name="qfMaxArea" type="number" step="0.01" placeholder="可留空" />
          </div>
          <div>
            <label for="xfMaxArea">现房最大面积</label>
            <input id="xfMaxArea" name="xfMaxArea" type="number" step="0.01" placeholder="可留空" />
          </div>
          <div class="grid" style="grid-column: span 2;">
            <div style="grid-column: span 4;">
              <label>现房小区（多选，留空=全部现房）</label>
              <div class="dropdown" id="xfDropdown">
                <button type="button" class="dropdown-btn" id="xfDropdownBtn">全部现房</button>
                <div class="dropdown-menu" id="xfDropdownMenu" style="display:none;">
                  <div class="xf-actions">
                    <button type="button" class="btn" id="xfSelectAll">全选</button>
                    <button type="button" class="btn secondary" id="xfClearAll">清空</button>
                  </div>
                  <div id="xfOptions"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button type="submit" class="btn" id="btn-solve">计算</button>
            <span id="msg" class="muted"></span>
          </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div class="muted">结果</div>
      <div class="row" style="gap:8px; align-items: center;">
        <div id="count" class="muted"></div>
        <button type="button" class="btn secondary" id="btn-export-table" disabled>导出表格到 Excel</button>
      </div>
    </div>
    <div class="row" style="gap:8px; margin:8px 0;">
      <select id="structureFilter" style="width:200px;">
        <option value="none">套型组合：不限</option>
        <option value="LMM">大+中+中</option>
        <option value="LLS">大+大+小</option>
        <option value="MMMS">中+中+中+小</option>
        <option value="MMSS">中+中+小+小</option>
      </select>
      <select id="qfCountFilter" style="width:160px;">
        <option value="any">期房数量：不限</option>
        <option value="0">期房数量：0</option>
        <option value="1">期房数量：1</option>
        <option value="2">期房数量：2</option>
        <option value="3">期房数量：3</option>
      </select>
      <select id="xfCountFilter" style="width:160px;">
        <option value="any">现房数量：不限</option>
        <option value="0">现房数量：0</option>
        <option value="1">现房数量：1</option>
        <option value="2">现房数量：2</option>
        <option value="3">现房数量：3</option>
        <option value="4">现房数量：4</option>
      </select>
      <div class="dropdown" id="qfFloorDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="qfFloorDropdownBtn">期房楼层：不限</button>
        <div class="dropdown-menu" id="qfFloorDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="qfFloorSelectAll">全选</button>
            <button type="button" class="btn secondary" id="qfFloorClearAll">清空</button>
          </div>
          <div id="qfFloorOptions"></div>
        </div>
      </div>
      <div class="dropdown" id="xfFloorDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="xfFloorDropdownBtn">现房楼层：不限</button>
        <div class="dropdown-menu" id="xfFloorDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="xfFloorSelectAll">全选</button>
            <button type="button" class="btn secondary" id="xfFloorClearAll">清空</button>
          </div>
          <div id="xfFloorOptions"></div>
        </div>
      </div>
      <!-- 新增：期房/现房 A/B/C 类别筛选 -->
      <div class="dropdown" id="qfCatDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="qfCatDropdownBtn">期房类别：不限</button>
        <div class="dropdown-menu" id="qfCatDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="qfCatSelectAll">全选</button>
            <button type="button" class="btn secondary" id="qfCatClearAll">清空</button>
          </div>
          <div id="qfCatOptions"></div>
        </div>
      </div>
      <div class="dropdown" id="xfCatDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="xfCatDropdownBtn">现房类别：不限</button>
        <div class="dropdown-menu" id="xfCatDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="xfCatSelectAll">全选</button>
            <button type="button" class="btn secondary" id="xfCatClearAll">清空</button>
          </div>
          <div id="xfCatOptions"></div>
        </div>
      </div>
      <!-- 新增：期房/现房 幢号筛选 -->
      <div class="dropdown" id="qfBuildingDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="qfBuildingDropdownBtn">期房幢号：不限</button>
        <div class="dropdown-menu" id="qfBuildingDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="qfBuildingSelectAll">全选</button>
            <button type="button" class="btn secondary" id="qfBuildingClearAll">清空</button>
          </div>
          <div id="qfBuildingOptions"></div>
        </div>
      </div>
      <div class="dropdown" id="xfBuildingDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="xfBuildingDropdownBtn">现房幢号：不限</button>
        <div class="dropdown-menu" id="xfBuildingDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="xfBuildingSelectAll">全选</button>
            <button type="button" class="btn secondary" id="xfBuildingClearAll">清空</button>
          </div>
          <div id="xfBuildingOptions"></div>
        </div>
      </div>
      <!-- 新增：期房/现房 门牌号筛选 -->
      <div class="dropdown" id="qfDoorDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="qfDoorDropdownBtn">期房门牌：不限</button>
        <div class="dropdown-menu" id="qfDoorDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="qfDoorSelectAll">全选</button>
            <button type="button" class="btn secondary" id="qfDoorClearAll">清空</button>
          </div>
          <div id="qfDoorOptions"></div>
        </div>
      </div>
      <div class="dropdown" id="xfDoorDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="xfDoorDropdownBtn">现房门牌：不限</button>
        <div class="dropdown-menu" id="xfDoorDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="xfDoorSelectAll">全选</button>
            <button type="button" class="btn secondary" id="xfDoorClearAll">清空</button>
          </div>
          <div id="xfDoorOptions"></div>
        </div>
      </div>
      <label class="badge" style="cursor:pointer; display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="xfBig12Only" />
        <span>仅显示：含现房且存在 >100 平 的现房在 1/2 楼</span>
      </label>
      <button type="button" class="btn" id="filterClear">清空筛选</button>
    </div>
    <div id="results" class="results">尚未计算</div>
  </div>

  <div class="card">
    <div class="muted">说明</div>
    <ul class="muted">
      <li>类型标记：期房显示 A/B/C + “(期房)”并追加 幢号/门牌号/室号（若有），如“A(期房) 1幢 29号 101室”；现房显示 类别 + “(现房)”并追加 小区名称+幢号+门牌号+室号，如“A(现房) (景香苑 1幢 29号 101室)”。</li>
      <li>字段含义：“兑换面积”（组合总面积）、“目标面积”（输入目标）、“浪费面积”（目标面积 - 兑换面积）。</li>
      <li>服务器默认端口：http://localhost:3000 。可在 server.js 中修改。</li>
    </ul>
  </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="var s=document.createElement('script'); s.src='/vendor/xlsx.full.min.js'; document.head.appendChild(s);"></script>
  <script>
    // Runtime check: if CDN load was blocked and onerror didn’t fire, load local fallback
    if (typeof XLSX === 'undefined') {
      var s = document.createElement('script');
      s.src = '/vendor/xlsx.full.min.js';
      document.head.appendChild(s);
    }
  </script>
  <script>
    async function loadConfig() {
      try {
        const res = await fetch('/config');
        if (!res.ok) throw new Error('配置加载失败');
        const cfg = await res.json();
        document.getElementById('topK').value = cfg.topK ?? 10;
        document.getElementById('source').value = (cfg.source ?? 'AB').toUpperCase();
        document.getElementById('minArea').value = (cfg.minArea ?? '');
        document.getElementById('qfMaxArea').value = (cfg.maxArea ?? '');
        document.getElementById('xfMaxArea').value = (cfg.xfMaxArea ?? 130.82);

        // 目标面积预设：从配置读取 targetPresets[0..1]，否则使用默认值
        const presets = Array.isArray(cfg.targetPresets) ? cfg.targetPresets.slice(0, 2) : [];
        const p1 = presets[0] ?? 318.64;
        const p2 = presets[1] ?? 300;
        const preset1Input = document.getElementById('targetPreset1');
        const preset2Input = document.getElementById('targetPreset2');
        const preset1Label = document.getElementById('targetPreset1Label');
        const preset2Label = document.getElementById('targetPreset2Label');
        if (preset1Input) preset1Input.value = String(p1);
        if (preset2Input) preset2Input.value = String(p2);
        if (preset1Label) preset1Label.textContent = String(p1);
        if (preset2Label) preset2Label.textContent = String(p2);

        const policy = cfg.policy || {};
        const badge = document.getElementById('cfg-badge');
        const polText = policy.disallowDominantWithSmallOthers
          ? `策略启用：> ${policy.dominantMoreThan} 且其余 < ${policy.othersLessThan} 组合剔除`
          : '策略关闭';
        badge.textContent = `默认 topK=${cfg.topK ?? 10}，${polText}`;
      } catch (e) {
        document.getElementById('cfg-badge').textContent = '配置加载失败';
        // 设置默认现房最大面积
        document.getElementById('xfMaxArea').value = 130.82;
      }
    }

    function buildQuery(params) {
      const sp = new URLSearchParams();
      Object.entries(params).forEach(([k, v]) => {
        if (v === undefined || v === null || v === '') return;
        if (Array.isArray(v)) {
          v.forEach((item) => {
            if (item !== undefined && item !== null && item !== '') sp.append(k, item);
          });
        } else {
          sp.set(k, v);
        }
      });
      return sp.toString();
    }

    // 现房小区多选下拉逻辑
    function getXfSelected() {
      const boxes = Array.from(document.querySelectorAll('#xfOptions input[type="checkbox"]:checked'));
      return boxes.map(b => b.value);
    }
    function setAllXfSelected(flag) {
      const boxes = Array.from(document.querySelectorAll('#xfOptions input[type="checkbox"]'));
      boxes.forEach(b => { b.checked = !!flag; });
      updateXfBtnLabel();
    }
    function updateXfBtnLabel() {
      const btn = document.getElementById('xfDropdownBtn');
      if (!btn) return;
      const sel = getXfSelected();
      if (sel.length === 0) {
        btn.textContent = '全部现房';
        btn.title = '全部现房';
      } else {
        const names = sel.join('、');
        btn.textContent = `已选 ${sel.length} 个小区：${names}`;
        btn.title = `已选 ${sel.length} 个小区：${names}`;
      }
    }
    function setupXfDropdown() {
      const btn = document.getElementById('xfDropdownBtn');
      const menu = document.getElementById('xfDropdownMenu');
      const selectAll = document.getElementById('xfSelectAll');
      const clearAll = document.getElementById('xfClearAll');
      if (!btn || !menu) return;

      btn.addEventListener('click', () => {
        menu.style.display = menu.style.display === 'none' ? '' : 'none';
      });
      document.addEventListener('click', (e) => {
        const dd = document.getElementById('xfDropdown');
        if (!dd) return;
        if (!dd.contains(e.target)) {
          menu.style.display = 'none';
        }
      });
      selectAll?.addEventListener('click', () => setAllXfSelected(true));
      clearAll?.addEventListener('click', () => setAllXfSelected(false));
      // 监听选项变化更新按钮文案
      document.getElementById('xfOptions')?.addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateXfBtnLabel();
        }
      });
    }

    function renderTable(data) {
      if (!Array.isArray(data) || data.length === 0) {
        return '<div class="muted">无结果</div>';
      }
      // 默认：按“浪费面积”从小到大排序
      data = [...data].sort((a, b) => {
        const gapA = parseFloat(a["浪费面积"]) || 0;
        const gapB = parseFloat(b["浪费面积"]) || 0;
        return gapA - gapB;
      });
      const rows = data.map((row, idx) => {
        // 每行横向按面积从大到小，无论期房/现房
        const items = Array.isArray(row.result) ? row.result.filter(Boolean) : [];
        const ordered = items.slice().sort((a, b) => Number(b[0]) - Number(a[0]));
        const cells = Array(4).fill('').map((_, i) => {
          const item = ordered[i];
          return item ? `${item[0]} ${item[1]}` : '';
        });
        const exchange = row["兑换面积"];
        const target = row["目标面积"];
        const gap = row["浪费面积"];
        return `<tr>
          <td>${idx + 1}</td>
          <td>${cells[0]}</td>
          <td>${cells[1]}</td>
          <td>${cells[2]}</td>
          <td>${cells[3]}</td>
          <td>${exchange}</td>
          <td>${target}</td>
          <td>${gap}</td>
        </tr>`;
      }).join('');
      return `<table>
        <thead>
          <tr>
            <th class="sortable" data-sort="index">#</th>
            <th>房1</th>
            <th>房2</th>
            <th>房3</th>
            <th>房4</th>
            <th class="sortable" data-sort="exchange">兑换面积</th>
            <th class="sortable" data-sort="target">目标面积</th>
            <th class="sortable" data-sort="gap">浪费面积</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    function sortTableBy(key, dir) {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const idxMap = { index: 0, exchange: 5, target: 6, gap: 7 };
      const colIndex = idxMap[key];
      if (colIndex === undefined) return;
      rows.sort((r1, r2) => {
        const t1 = r1.children[colIndex]?.textContent.trim() || '';
        const t2 = r2.children[colIndex]?.textContent.trim() || '';
        let v1, v2;
        if (key === 'index') {
          v1 = parseInt(t1, 10) || 0;
          v2 = parseInt(t2, 10) || 0;
        } else {
          v1 = parseFloat(t1) || 0;
          v2 = parseFloat(t2) || 0;
        }
        return dir === 'asc' ? (v1 - v2) : (v2 - v1);
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    // 解析房源文本信息
    function parseCellInfo(text) {
      const t = (text || '').trim();
      if (!t) return null;
      const isQF = t.includes('(期房)');
      const isXF = t.includes('(现房)');
      const type = isQF ? 'qf' : (isXF ? 'xf' : null);

      // 类别（A/B/C）可能出现在面积之后，如 "95.23 A(期房) ..."，因此不能只匹配开头
      let category = null;
      const catMatchStrict = t.match(/\b([ABC])\s*\((期房|现房)\)/);
      if (catMatchStrict) {
        category = catMatchStrict[1];
      } else {
        const catMatchLoose = t.match(/\b([ABC])\s*\(/);
        category = catMatchLoose ? catMatchLoose[1] : null;
      }

      const buildMatch = t.match(/(\d+)\s*幢/);
      const building = buildMatch ? parseInt(buildMatch[1], 10) : null;
      const doorMatch = t.match(/(\d+)\s*号/);
      const door = doorMatch ? parseInt(doorMatch[1], 10) : null;
      const roomMatch = t.match(/(\d+)\s*室/);
      const room = roomMatch ? parseInt(roomMatch[1], 10) : null;
      const floor = (room && Number.isFinite(room)) ? Math.floor(room / 100) : null;
      return { type, category, building, door, room, floor };
    }

    function buildDynamicFilterOptions() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');

      const qfFloorCont = document.getElementById('qfFloorOptions');
      const xfFloorCont = document.getElementById('xfFloorOptions');
      const qfCatCont = document.getElementById('qfCatOptions');
      const xfCatCont = document.getElementById('xfCatOptions');
      const qfBuildCont = document.getElementById('qfBuildingOptions');
      const xfBuildCont = document.getElementById('xfBuildingOptions');
      const qfDoorCont = document.getElementById('qfDoorOptions');
      const xfDoorCont = document.getElementById('xfDoorOptions');

      const qfFloorBtn = document.getElementById('qfFloorDropdownBtn');
      const xfFloorBtn = document.getElementById('xfFloorDropdownBtn');
      const qfCatBtn = document.getElementById('qfCatDropdownBtn');
      const xfCatBtn = document.getElementById('xfCatDropdownBtn');
      const qfBuildBtn = document.getElementById('qfBuildingDropdownBtn');
      const xfBuildBtn = document.getElementById('xfBuildingDropdownBtn');
      const qfDoorBtn = document.getElementById('qfDoorDropdownBtn');
      const xfDoorBtn = document.getElementById('xfDoorDropdownBtn');

      // 清空容器
      [qfFloorCont, xfFloorCont, qfCatCont, xfCatCont, qfBuildCont, xfBuildCont, qfDoorCont, xfDoorCont].forEach(c => { if (c) c.innerHTML = ''; });

      if (!table) {
        if (qfFloorBtn) qfFloorBtn.textContent = '期房楼层：不限';
        if (xfFloorBtn) xfFloorBtn.textContent = '现房楼层：不限';
        if (qfCatBtn) qfCatBtn.textContent = '期房类别：不限';
        if (xfCatBtn) xfCatBtn.textContent = '现房类别：不限';
        if (qfBuildBtn) qfBuildBtn.textContent = '期房幢号：不限';
        if (xfBuildBtn) xfBuildBtn.textContent = '现房幢号：不限';
        if (qfDoorBtn) qfDoorBtn.textContent = '期房门牌：不限';
        if (xfDoorBtn) xfDoorBtn.textContent = '现房门牌：不限';
        return;
      }

      const qfFloors = new Set();
      const xfFloors = new Set();
      const qfCats = new Set();
      const xfCats = new Set();
      const qfBuildings = new Set();
      const xfBuildings = new Set();
      const qfDoors = new Set();
      const xfDoors = new Set();

      const trs = Array.from(table.querySelectorAll('tbody tr'));
      trs.forEach(tr => {
        for (let i = 1; i <= 4; i++) {
          const text = tr.children[i]?.textContent || '';
          const info = parseCellInfo(text);
          if (!info || !info.type) continue;
          if (info.type === 'qf') {
            if (info.floor && info.floor > 0) qfFloors.add(info.floor);
            if (info.category) qfCats.add(info.category);
            if (Number.isFinite(info.building)) qfBuildings.add(info.building);
            if (Number.isFinite(info.door)) qfDoors.add(info.door);
          } else if (info.type === 'xf') {
            if (info.floor && info.floor > 0) xfFloors.add(info.floor);
            if (info.category) xfCats.add(info.category);
            if (Number.isFinite(info.building)) xfBuildings.add(info.building);
            if (Number.isFinite(info.door)) xfDoors.add(info.door);
          }
        }
      });

      const makeOptionRow = (idPrefix, value) => {
        const id = idPrefix + '_' + value;
        const row = document.createElement('div');
        row.className = 'xf-option';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.value = String(value);
        const lab = document.createElement('label');
        lab.setAttribute('for', id);
        lab.textContent = String(value);
        row.appendChild(cb);
        row.appendChild(lab);
        return row;
      };

      // 构建选项
      const qFloors = Array.from(qfFloors).sort((a, b) => a - b);
      const xFloors = Array.from(xfFloors).sort((a, b) => a - b);
      const qCats = Array.from(qfCats).sort();
      const xCats = Array.from(xfCats).sort();
      const qBuilds = Array.from(qfBuildings).sort((a, b) => a - b);
      const xBuilds = Array.from(xfBuildings).sort((a, b) => a - b);
      const qDoorsArr = Array.from(qfDoors).sort((a, b) => a - b);
      const xDoorsArr = Array.from(xfDoors).sort((a, b) => a - b);

      if (qfFloorCont) qFloors.forEach(f => qfFloorCont.appendChild(makeOptionRow('qfFloor', f)));
      if (xfFloorCont) xFloors.forEach(f => xfFloorCont.appendChild(makeOptionRow('xfFloor', f)));
      if (qfCatCont) qCats.forEach(c => qfCatCont.appendChild(makeOptionRow('qfCat', c)));
      if (xfCatCont) xCats.forEach(c => xfCatCont.appendChild(makeOptionRow('xfCat', c)));
      if (qfBuildCont) qBuilds.forEach(b => qfBuildCont.appendChild(makeOptionRow('qfBuild', b)));
      if (xfBuildCont) xBuilds.forEach(b => xfBuildCont.appendChild(makeOptionRow('xfBuild', b)));
      if (qfDoorCont) qDoorsArr.forEach(d => qfDoorCont.appendChild(makeOptionRow('qfDoor', d)));
      if (xfDoorCont) xDoorsArr.forEach(d => xfDoorCont.appendChild(makeOptionRow('xfDoor', d)));

      // 下拉开关与外部点击关闭
      function setupDropdown(ddId, btnId, menuId) {
        const dd = document.getElementById(ddId);
        const btn = document.getElementById(btnId);
        const menu = document.getElementById(menuId);
        if (btn) btn.onclick = () => { if (menu) menu.style.display = menu.style.display === 'none' ? '' : 'none'; };
        document.addEventListener('click', (e) => {
          if (dd && !dd.contains(e.target)) { if (menu) menu.style.display = 'none'; }
        });
      }

      setupDropdown('qfFloorDropdown', 'qfFloorDropdownBtn', 'qfFloorDropdownMenu');
      setupDropdown('xfFloorDropdown', 'xfFloorDropdownBtn', 'xfFloorDropdownMenu');
      setupDropdown('qfCatDropdown', 'qfCatDropdownBtn', 'qfCatDropdownMenu');
      setupDropdown('xfCatDropdown', 'xfCatDropdownBtn', 'xfCatDropdownMenu');
      setupDropdown('qfBuildingDropdown', 'qfBuildingDropdownBtn', 'qfBuildingDropdownMenu');
      setupDropdown('xfBuildingDropdown', 'xfBuildingDropdownBtn', 'xfBuildingDropdownMenu');
      setupDropdown('qfDoorDropdown', 'qfDoorDropdownBtn', 'qfDoorDropdownMenu');
      setupDropdown('xfDoorDropdown', 'xfDoorDropdownBtn', 'xfDoorDropdownMenu');

      // 全选/清空按钮
      function setAllSelected(containerSelector, flag) {
        const boxes = Array.from(document.querySelectorAll(containerSelector + ' input[type="checkbox"]'));
        boxes.forEach(b => { b.checked = !!flag; });
        updateDropdownBtnLabels();
        applyFilter();
      }
      document.getElementById('qfFloorSelectAll')?.addEventListener('click', () => setAllSelected('#qfFloorOptions', true));
      document.getElementById('qfFloorClearAll')?.addEventListener('click', () => setAllSelected('#qfFloorOptions', false));
      document.getElementById('xfFloorSelectAll')?.addEventListener('click', () => setAllSelected('#xfFloorOptions', true));
      document.getElementById('xfFloorClearAll')?.addEventListener('click', () => setAllSelected('#xfFloorOptions', false));

      document.getElementById('qfCatSelectAll')?.addEventListener('click', () => setAllSelected('#qfCatOptions', true));
      document.getElementById('qfCatClearAll')?.addEventListener('click', () => setAllSelected('#qfCatOptions', false));
      document.getElementById('xfCatSelectAll')?.addEventListener('click', () => setAllSelected('#xfCatOptions', true));
      document.getElementById('xfCatClearAll')?.addEventListener('click', () => setAllSelected('#xfCatOptions', false));

      document.getElementById('qfBuildingSelectAll')?.addEventListener('click', () => setAllSelected('#qfBuildingOptions', true));
      document.getElementById('qfBuildingClearAll')?.addEventListener('click', () => setAllSelected('#qfBuildingOptions', false));
      document.getElementById('xfBuildingSelectAll')?.addEventListener('click', () => setAllSelected('#xfBuildingOptions', true));
      document.getElementById('xfBuildingClearAll')?.addEventListener('click', () => setAllSelected('#xfBuildingOptions', false));

      document.getElementById('qfDoorSelectAll')?.addEventListener('click', () => setAllSelected('#qfDoorOptions', true));
      document.getElementById('qfDoorClearAll')?.addEventListener('click', () => setAllSelected('#qfDoorOptions', false));
      document.getElementById('xfDoorSelectAll')?.addEventListener('click', () => setAllSelected('#xfDoorOptions', true));
      document.getElementById('xfDoorClearAll')?.addEventListener('click', () => setAllSelected('#xfDoorOptions', false));

      // 选项变化事件
      ['qfFloorOptions', 'xfFloorOptions', 'qfCatOptions', 'xfCatOptions', 'qfBuildingOptions', 'xfBuildingOptions', 'qfDoorOptions', 'xfDoorOptions'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', (e) => {
          if (e.target && e.target.matches('input[type="checkbox"]')) {
            updateDropdownBtnLabels();
            applyFilter();
          }
        });
      });

      function updateDropdownBtnLabels() {
        const qSelFloors = Array.from(document.querySelectorAll('#qfFloorOptions input[type="checkbox"]:checked')).map(b => b.value);
        const xSelFloors = Array.from(document.querySelectorAll('#xfFloorOptions input[type="checkbox"]:checked')).map(b => b.value);
        const qSelCats = Array.from(document.querySelectorAll('#qfCatOptions input[type="checkbox"]:checked')).map(b => b.value);
        const xSelCats = Array.from(document.querySelectorAll('#xfCatOptions input[type="checkbox"]:checked')).map(b => b.value);
        const qSelBuilds = Array.from(document.querySelectorAll('#qfBuildingOptions input[type="checkbox"]:checked')).map(b => b.value);
        const xSelBuilds = Array.from(document.querySelectorAll('#xfBuildingOptions input[type="checkbox"]:checked')).map(b => b.value);
        const qSelDoors = Array.from(document.querySelectorAll('#qfDoorOptions input[type="checkbox"]:checked')).map(b => b.value);
        const xSelDoors = Array.from(document.querySelectorAll('#xfDoorOptions input[type="checkbox"]:checked')).map(b => b.value);

        if (qfFloorBtn) qfFloorBtn.textContent = qSelFloors.length ? ('期房楼层：' + qSelFloors.join('、')) : '期房楼层：不限';
        if (xfFloorBtn) xfFloorBtn.textContent = xSelFloors.length ? ('现房楼层：' + xSelFloors.join('、')) : '现房楼层：不限';
        if (qfCatBtn) qfCatBtn.textContent = qSelCats.length ? ('期房类别：' + qSelCats.join('、')) : '期房类别：不限';
        if (xfCatBtn) xfCatBtn.textContent = xSelCats.length ? ('现房类别：' + xSelCats.join('、')) : '现房类别：不限';
        if (qfBuildBtn) qfBuildBtn.textContent = qSelBuilds.length ? ('期房幢号：' + qSelBuilds.join('、')) : '期房幢号：不限';
        if (xfBuildBtn) xfBuildBtn.textContent = xSelBuilds.length ? ('现房幢号：' + xSelBuilds.join('、')) : '现房幢号：不限';
        if (qfDoorBtn) qfDoorBtn.textContent = qSelDoors.length ? ('期房门牌：' + qSelDoors.join('、')) : '期房门牌：不限';
        if (xfDoorBtn) xfDoorBtn.textContent = xSelDoors.length ? ('现房门牌：' + xSelDoors.join('、')) : '现房门牌：不限';
      }

      updateDropdownBtnLabels();
    }

    function applyFilter() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      const countEl = document.getElementById('count');
      if (!table) {
        countEl.textContent = '';
        return;
      }
      const keywordEl = document.getElementById('filterText');
      const modeEl = document.getElementById('filterMode');
      const keyword = keywordEl ? keywordEl.value.trim() : '';
      const mode = modeEl ? (modeEl.value || 'include') : 'include';
      const struct = (document.getElementById('structureFilter')?.value) || 'none';
      const qSel = (document.getElementById('qfCountFilter')?.value) || 'any';
      const xSel = (document.getElementById('xfCountFilter')?.value) || 'any';

      // 收集下拉多选值
      function getCheckedValues(selector, toNumber = false) {
        const vals = Array.from(document.querySelectorAll(selector + ' input[type="checkbox"]:checked')).map(b => b.value);
        if (!toNumber) return vals;
        return vals.map(v => Number(v)).filter(n => Number.isFinite(n));
      }
      const qFloorSel = getCheckedValues('#qfFloorOptions', true);
      const xfFloorSel = getCheckedValues('#xfFloorOptions', true);
      const qCatSel = getCheckedValues('#qfCatOptions', false);
      const xfCatSel = getCheckedValues('#xfCatOptions', false);
      const qBuildSel = getCheckedValues('#qfBuildingOptions', true);
      const xfBuildSel = getCheckedValues('#xfBuildingOptions', true);
      const qDoorSel = getCheckedValues('#qfDoorOptions', true);
      const xfDoorSel = getCheckedValues('#xfDoorOptions', true);

      function categorizeArea(a) {
        if (!Number.isFinite(a)) return '空';
        if (a > 100) return '大';
        if (a > 70 && a < 100) return '中';
        if (a < 70) return '小';
        return '边界';
      }

      function matchesStructurePattern(cats, patternKey) {
        // 仅统计非空类别
        const present = cats.filter(c => c !== '空');
        const count = present.length;
        const cnt = { '大': 0, '中': 0, '小': 0 };
        present.forEach(c => { if (cnt[c] !== undefined) cnt[c]++; });

        if (patternKey === 'LMM') {
          // 大+中+中（恰好 3 项：1 大 2 中）
          return count === 3 && cnt['大'] === 1 && cnt['中'] === 2 && cnt['小'] === 0;
        }
        if (patternKey === 'LLS') {
          // 大+大+小（恰好 3 项：2 大 1 小）
          return count === 3 && cnt['大'] === 2 && cnt['小'] === 1 && cnt['中'] === 0;
        }
        if (patternKey === 'MMMS') {
          // 中+中+中+小（恰好 4 项：3 中 1 小）
          return count === 4 && cnt['中'] === 3 && cnt['小'] === 1 && cnt['大'] === 0;
        }
        if (patternKey === 'MMSS') {
          // 中+中+小+小（恰好 4 项：2 中 2 小）
          return count === 4 && cnt['中'] === 2 && cnt['小'] === 2 && cnt['大'] === 0;
        }
        return true; // 'none' 或未知键：不过滤
      }

      const rows = Array.from(table.querySelectorAll('tbody tr'));
      let visibleCount = 0;
      rows.forEach(tr => {
        // 文本筛选（房1~房4）
        const text = [1, 2, 3, 4].map(i => tr.children[i]?.textContent || '').join(' ');
        const has = keyword ? text.includes(keyword) : true;
        const showKeyword = keyword ? (mode === 'include' ? has : !has) : true;

        // 结构筛选：解析面积并分类
        const nums = [1, 2, 3, 4].map(i => parseFloat(tr.children[i]?.textContent || '')).filter(n => Number.isFinite(n));
        const cats = nums.map(categorizeArea);
        const showStruct = struct === 'none' ? true : matchesStructurePattern(cats, struct);

        // 统计当前行期房/现房数量，并收集详细属性
        const infoItems = [1, 2, 3, 4].map(i => parseCellInfo(tr.children[i]?.textContent || '')).filter(Boolean);
        const counts = infoItems.reduce((acc, it) => {
          if (it.type === 'qf') acc.q++;
          else if (it.type === 'xf') acc.x++;
          return acc;
        }, { q: 0, x: 0 });
        const showQ = qSel === 'any' ? true : counts.q === Number(qSel);
        const showX = xSel === 'any' ? true : counts.x === Number(xSel);

        // 楼层筛选（多选）：分别提取期房与现房楼层，任一命中所选集合即可
        const qFloors = infoItems.filter(it => it.type === 'qf' && Number.isFinite(it.floor)).map(it => it.floor);
        const xFloors = infoItems.filter(it => it.type === 'xf' && Number.isFinite(it.floor)).map(it => it.floor);
        const showQF = qFloorSel.length === 0 ? true : qFloors.some(f => qFloorSel.includes(f));
        const showXF = xfFloorSel.length === 0 ? true : xFloors.some(f => xfFloorSel.includes(f));
        const showF = showQF && showXF;

        // 类别 A/B/C 筛选
        const qCatsRow = infoItems.filter(it => it.type === 'qf' && it.category).map(it => it.category);
        const xCatsRow = infoItems.filter(it => it.type === 'xf' && it.category).map(it => it.category);
        const showQCat = qCatSel.length === 0 ? true : qCatsRow.some(c => qCatSel.includes(c));
        const showXCat = xfCatSel.length === 0 ? true : xCatsRow.some(c => xfCatSel.includes(c));

        // 幢号筛选
        const qBuildsRow = infoItems.filter(it => it.type === 'qf' && Number.isFinite(it.building)).map(it => it.building);
        const xBuildsRow = infoItems.filter(it => it.type === 'xf' && Number.isFinite(it.building)).map(it => it.building);
        const showQBuild = qBuildSel.length === 0 ? true : qBuildsRow.some(b => qBuildSel.includes(b));
        const showXBuild = xfBuildSel.length === 0 ? true : xBuildsRow.some(b => xfBuildSel.includes(b));

        // 门牌号筛选（期房严格包含：若选择了门牌号，则该行所有期房门牌必须都在选择集合中）
        const qDoorsRow = infoItems.filter(it => it.type === 'qf' && Number.isFinite(it.door)).map(it => it.door);
        const xDoorsRow = infoItems.filter(it => it.type === 'xf' && Number.isFinite(it.door)).map(it => it.door);
        // 期房门牌：当选择集合非空时，要求至少有一个期房门牌，且所有期房门牌都属于选择集合
        const showQDoor = qDoorSel.length === 0
          ? true
          : (qDoorsRow.length > 0 && qDoorsRow.every(d => qDoorSel.includes(d)));
        // 现房门牌：保持“任一命中即可”的宽松逻辑
        const showXDoor = xfDoorSel.length === 0 ? true : xDoorsRow.some(d => xfDoorSel.includes(d));

        const xfBig12Only = document.getElementById('xfBig12Only')?.checked;
        let showSpecial = true;
        if (xfBig12Only) {
          // 仅显示包含“现房且面积>100 且楼层为 1/2”的任意一套
          const hasXfBig12 = [1, 2, 3, 4].some(i => {
            const cellText = tr.children[i]?.textContent || '';
            const info = parseCellInfo(cellText);
            if (!info || info.type !== 'xf') return false;
            const area = parseFloat(cellText);
            const floor = info.floor;
            return Number.isFinite(area) && area > 100 && (floor === 1 || floor === 2);
          });
          showSpecial = hasXfBig12;
        }

        const show = showKeyword && showStruct && showQ && showX && showF && showQCat && showXCat && showQBuild && showXBuild && showQDoor && showXDoor && showSpecial;
        tr.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });
      countEl.textContent = '共 ' + visibleCount + ' 条结果';
      // 始终保持按“浪费面积”从小到大排序
      window.__sortKey = 'gap';
      window.__sortDir = 'asc';
      sortTableBy('gap', 'asc');
    }

    function bindTableEnhancements() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      if (!table) return;
      const headers = table.querySelectorAll('thead th[data-sort]');
      headers.forEach(th => {
        const key = th.getAttribute('data-sort');
        th.addEventListener('click', () => {
          if (window.__sortKey === key) {
            window.__sortDir = window.__sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            window.__sortKey = key;
            window.__sortDir = key === 'index' ? 'asc' : 'desc';
          }
          sortTableBy(window.__sortKey, window.__sortDir);
        });
      });
    }

    async function onSubmit(e) {
      e.preventDefault();
      const msg = document.getElementById('msg');
      const resultsEl = document.getElementById('results');
      const countEl = document.getElementById('count');
      msg.textContent = '';
      countEl.textContent = '';

      const targetNum = getSelectedTarget();
      if (!Number.isFinite(targetNum) || targetNum <= 0) {
        msg.textContent = '请选择预设目标面积或输入有效的自定义面积';
        return;
      }

      const topK = document.getElementById('topK').value;
      const source = document.getElementById('source').value;
      const minArea = document.getElementById('minArea').value;
      const qfMaxArea = document.getElementById('qfMaxArea').value;
      const xfMaxArea = document.getElementById('xfMaxArea').value;
      const xfSel = getXfSelected();
      const giftArea = Number(document.getElementById('giftArea')?.value || 0);
      const maxArea = giftArea > 0 ? xfMaxArea : qfMaxArea;

      const qs = buildQuery({
        target: targetNum, giftArea, topK, source,
        minArea, maxArea,
        xfCommunities: xfSel
      });

      try {
        setLoading(true);
        resultsEl.textContent = '计算中...';
        const res = await fetch('/solve?' + qs);
        const data = await res.json();
        if (!res.ok) {
          resultsEl.innerHTML = '<span class="error">' + (data.error || '请求失败') + '</span>';
          setLoading(false);
          return;
        }
        resultsEl.innerHTML = renderTable(data);
        bindTableEnhancements();
        buildDynamicFilterOptions();
        applyFilter();
        updateExportButtonState();
        setLoading(false);
      } catch (err) {
        resultsEl.innerHTML = '<span class="error">' + err.message + '</span>';
        setLoading(false);
      }
    }

    function updateExportButtonState() {
      const btn = document.getElementById('btn-export-table');
      if (!btn) return;
      const table = document.getElementById('results').querySelector('table');
      btn.disabled = !table;
    }

    // 目标面积选择与读取
    function getSelectedTarget() {
      const r1 = document.getElementById('targetPreset1');
      const r2 = document.getElementById('targetPreset2');
      const rc = document.getElementById('targetCustomRadio');
      const custom = document.getElementById('targetCustom');
      if (rc && rc.checked) {
        const v = Number(custom?.value);
        if (Number.isFinite(v) && v > 0) return v;
        return null;
      }
      if (r1 && r1.checked) return Number(r1.value);
      if (r2 && r2.checked) return Number(r2.value);
      return null;
    }
    function setupTargetChoice() {
      const r1 = document.getElementById('targetPreset1');
      const r2 = document.getElementById('targetPreset2');
      const rc = document.getElementById('targetCustomRadio');
      const custom = document.getElementById('targetCustom');
      function update() {
        const showCustom = rc && rc.checked;
        if (custom) custom.style.display = showCustom ? '' : 'none';
      }
      [r1, r2, rc].forEach(el => el && el.addEventListener('change', update));
      update();
    }

    function setLoading(flag) {
      const ov = document.getElementById('loadingOverlay');
      const solveBtn = document.getElementById('btn-solve');
      if (ov) ov.style.display = flag ? 'flex' : 'none';
      if (solveBtn) solveBtn.disabled = !!flag;
    }

    function exportFilteredTableToExcel() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      const msg = document.getElementById('msg');
      if (!table) {
        if (msg) msg.textContent = '无表格可导出，请先计算';
        return;
      }
      // 若前端 XLSX 库未加载（可能被网络限制），回退到服务端导出
      if (typeof XLSX === 'undefined') {
        if (msg) msg.textContent = '前端 XLSX 库未加载，正在使用服务端导出…';
        // 从表单取当前参数，构建服务端导出请求
        const targetNum = getSelectedTarget();
        const topK = document.getElementById('topK').value;
        const source = document.getElementById('source').value;
        const minArea = document.getElementById('minArea').value;
        const qfMaxArea = document.getElementById('qfMaxArea').value;
        const xfMaxArea = document.getElementById('xfMaxArea').value;
        const xfSel = getXfSelected();
        const giftArea = Number(document.getElementById('giftArea')?.value || 0);
        const maxArea = giftArea > 0 ? xfMaxArea : qfMaxArea;
        const qs = buildQuery({
          target: targetNum, giftArea, topK, source,
          minArea, maxArea,
          xfCommunities: xfSel
        });
        // 跳转到服务端 /excel 下载
        window.location.href = '/excel?' + qs;
        return;
      }
      // 采集表头
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      // 采集可见行数据
      const rows = [];
      const trs = Array.from(table.querySelectorAll('tbody tr'));
      trs.forEach(tr => {
        if (tr.style.display === 'none') return;
        const row = Array.from(tr.children).map(td => (td.textContent || '').trim());
        rows.push(row);
      });
      if (rows.length === 0) {
        if (msg) msg.textContent = '当前筛选无可导出的行';
        return;
      }
      const aoa = [headers, ...rows];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '筛选结果');
      const targetNum = getSelectedTarget();
      const giftArea = Number(document.getElementById('giftArea')?.value || 0);
      const combined = Number.isFinite(targetNum) ? (targetNum + (Number.isFinite(giftArea) ? giftArea : 0)) : null;
      const fname = Number.isFinite(combined) ? ('results-' + combined + '.xlsx') : 'results.xlsx';
      XLSX.writeFile(wb, fname);
    }

    document.getElementById('solve-form').addEventListener('submit', onSubmit);
    document.getElementById('btn-export-table').addEventListener('click', exportFilteredTableToExcel);
    // 过滤控件事件绑定
    document.getElementById('filterText')?.addEventListener('input', applyFilter);
    document.getElementById('filterMode')?.addEventListener('change', applyFilter);
    document.getElementById('structureFilter').addEventListener('change', applyFilter);
    document.getElementById('qfCountFilter')?.addEventListener('change', applyFilter);
    document.getElementById('xfCountFilter')?.addEventListener('change', applyFilter);
    document.getElementById('xfBig12Only')?.addEventListener('change', applyFilter);
    document.getElementById('filterClear').addEventListener('click', () => {
      const input = document.getElementById('filterText');
      if (input) input.value = '';
      const qSel = document.getElementById('qfCountFilter');
      const xSel = document.getElementById('xfCountFilter');
      if (qSel) qSel.value = 'any';
      if (xSel) xSel.value = 'any';
      // 清空楼层/类别/幢号/门牌多选（期房/现房）
      const toClearSelectors = [
        '#qfFloorOptions', '#xfFloorOptions',
        '#qfCatOptions', '#xfCatOptions',
        '#qfBuildingOptions', '#xfBuildingOptions',
        '#qfDoorOptions', '#xfDoorOptions'
      ];
      toClearSelectors.forEach(sel => {
        const boxes = Array.from(document.querySelectorAll(sel + ' input[type="checkbox"]'));
        boxes.forEach(b => { b.checked = false; });
      });
      const labelDefaults = [
        ['qfFloorDropdownBtn', '期房楼层：不限'],
        ['xfFloorDropdownBtn', '现房楼层：不限'],
        ['qfCatDropdownBtn', '期房类别：不限'],
        ['xfCatDropdownBtn', '现房类别：不限'],
        ['qfBuildingDropdownBtn', '期房幢号：不限'],
        ['xfBuildingDropdownBtn', '现房幢号：不限'],
        ['qfDoorDropdownBtn', '期房门牌：不限'],
        ['xfDoorDropdownBtn', '现房门牌：不限']
      ];
      labelDefaults.forEach(([id, text]) => {
        const btn = document.getElementById(id);
        if (btn) btn.textContent = text;
      });

      applyFilter();
    });
    setupTargetChoice();
    loadConfig();
    (async function loadCommunities() {
      try {
        const res = await fetch('/communities?type=xf');
        if (!res.ok) throw new Error('小区列表加载失败');
        const list = await res.json();
        const cont = document.getElementById('xfOptions');
        if (cont && Array.isArray(list)) {
          cont.innerHTML = '';
          const defaults = new Set(['辰香苑','景香苑','景华新苑']);
          list.forEach((name, idx) => {
            const id = 'xfopt_' + idx;
            const row = document.createElement('div');
            row.className = 'xf-option';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.id = id;
            cb.value = name;
            cb.checked = defaults.has(name);
            const lab = document.createElement('label');
            lab.setAttribute('for', id);
            lab.textContent = name;
            row.appendChild(cb);
            row.appendChild(lab);
            cont.appendChild(row);
          });
          setupXfDropdown();
          updateXfBtnLabel();
        }
      } catch (e) {
        // ignore
      }
    })();
  </script>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="panel">
      <div class="spinner"></div>
      <div>计算中，请稍候…</div>
    </div>
  </div>
  <script>
    (function () {
      const THEME_KEY = 'theme';
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const btn = document.getElementById('themeToggleBtn');
        if (btn) {
          btn.textContent = theme === 'dark' ? '切换为白天' : '切换为夜间';
          btn.title = '当前：' + (theme === 'dark' ? '夜间' : '白天') + '，点击切换';
        }
      }
      function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (systemPrefersDark ? 'dark' : 'light');
        applyTheme(theme);
        const btn = document.getElementById('themeToggleBtn');
        if (btn) {
          btn.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, next);
            applyTheme(next);
          });
        }
        // If user hasn't explicitly chosen, follow system changes dynamically
        if (!saved && window.matchMedia) {
          const mq = window.matchMedia('(prefers-color-scheme: dark)');
          const handler = (e) => {
            const next = e.matches ? 'dark' : 'light';
            applyTheme(next);
          };
          if (mq.addEventListener) mq.addEventListener('change', handler);
          else if (mq.addListener) mq.addListener(handler);
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTheme);
      } else {
        initTheme();
      }
    })();
  </script>
</body>

</html>