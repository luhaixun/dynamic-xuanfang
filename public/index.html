<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>选房程序（内部版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22c55e;
      --accent-2: #60a5fa;
      --danger: #ef4444;
      --card: #1f2937;
      --input: #111827;
      --border: #1f2937;
    }

    html,
    body {
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .title {
      display: flex;
      align-items: baseline;
      gap: 12px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: var(--accent-2);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      color: #fff;
      background-image: radial-gradient(100% 100% at 100% 0, #4f46e5 0, #2563eb 100%);
      cursor: pointer;
      transition: transform .03s ease, box-shadow .15s ease;
      font-weight: 600;
    }

    .btn.secondary {
      background-image: radial-gradient(100% 100% at 100% 0, #22c55e 0, #16a34a 100%);
      border-color: #14532d;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .results {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      max-height: 420px;
      overflow: auto;
      font-size: 12px;
    }

    .error {
      color: var(--danger);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 16px;
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .results table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .results thead th {
      font-weight: 600;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }

    .results tbody td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
    }

    .results tbody tr:hover {
      background: rgba(96, 165, 250, 0.08);
    }

    .results thead th.sortable {
      cursor: pointer;
    }

    /* Dropdown with checkbox list */
    .dropdown {
      position: relative;
    }

    .dropdown-btn {
      width: 100%;
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      text-align: left;
      cursor: pointer;
    }

    .dropdown-btn:focus {
      border-color: var(--accent-2);
      outline: none;
    }

    .dropdown-menu {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      z-index: 1000;
      max-height: 300px;
      overflow: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
    }

    .dropdown-menu .xf-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-bottom: 8px;
    }

    .xf-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 2px;
    }

    .xf-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.65);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text);
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--accent-2);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="container">
    <div class="title">
      <h1>选房程序（内部版）</h1>
      <span class="badge" id="cfg-badge">加载配置...</span>
    </div>
    <p class="muted">在下方填写参数，然后点击“计算”查看结果。可在结果表右上角导出 Excel。</p>

    <div class="card">
      <form id="solve-form">
        <div class="grid">
          <div>
            <label for="target">目标面积 target（必填）</label>
            <input id="target" name="target" type="number" step="0.01" placeholder="示例：318.64" required />
          </div>
          <div>
            <label for="topK">返回数量 topK</label>
            <input id="topK" name="topK" type="number" step="1" min="1" placeholder="默认：10" />
          </div>
          <div>
            <label for="source">来源 source</label>
            <select id="source" name="source">
              <option value="AB">AB（默认）</option>
              <option value="A">仅 A</option>
              <option value="B">仅 B</option>
            </select>
          </div>
          <div>
            <label for="minArea">最小面积 minArea</label>
            <input id="minArea" name="minArea" type="number" step="0.01" placeholder="可留空" />
          </div>
          <div>
            <label for="maxArea">最大面积 maxArea</label>
            <input id="maxArea" name="maxArea" type="number" step="0.01" placeholder="可留空" />
          </div>
          <div class="grid">
            <div style="grid-column: span 4;">
              <label>现房小区（多选，留空=全部现房）</label>
              <div class="dropdown" id="xfDropdown">
                <button type="button" class="dropdown-btn" id="xfDropdownBtn">全部现房</button>
                <div class="dropdown-menu" id="xfDropdownMenu" style="display:none;">
                  <div class="xf-actions">
                    <button type="button" class="btn" id="xfSelectAll">全选</button>
                    <button type="button" class="btn secondary" id="xfClearAll">清空</button>
                  </div>
                  <div id="xfOptions"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button type="submit" class="btn" id="btn-solve">计算</button>
            <span id="msg" class="muted"></span>
          </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div class="muted">结果</div>
      <div class="row" style="gap:8px; align-items: center;">
        <div id="count" class="muted"></div>
        <button type="button" class="btn secondary" id="btn-export-table" disabled>导出表格到 Excel</button>
      </div>
    </div>
    <div class="row" style="gap:8px; margin:8px 0;">
      <input id="filterText" type="text" placeholder="筛选关键词，如 A(期房)/银香苑/景香苑" style="flex:1;" />
      <select id="filterMode" style="width:160px;">
        <option value="include">包含匹配</option>
        <option value="exclude">排除匹配</option>
      </select>
      <select id="structureFilter" style="width:200px;">
        <option value="none">套型组合：不限</option>
        <option value="LMM">大+中+中</option>
        <option value="LLS">大+大+小</option>
        <option value="MMMS">中+中+中+小</option>
        <option value="MMSS">中+中+小+小</option>
      </select>
      <select id="qfCountFilter" style="width:160px;">
        <option value="any">期房数量：不限</option>
        <option value="0">期房数量：0</option>
        <option value="1">期房数量：1</option>
        <option value="2">期房数量：2</option>
        <option value="3">期房数量：3</option>
      </select>
      <select id="xfCountFilter" style="width:160px;">
        <option value="any">现房数量：不限</option>
        <option value="0">现房数量：0</option>
        <option value="1">现房数量：1</option>
        <option value="2">现房数量：2</option>
        <option value="3">现房数量：3</option>
        <option value="4">现房数量：4</option>
      </select>
      <div class="dropdown" id="qfFloorDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="qfFloorDropdownBtn">期房楼层：不限</button>
        <div class="dropdown-menu" id="qfFloorDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="qfFloorSelectAll">全选</button>
            <button type="button" class="btn secondary" id="qfFloorClearAll">清空</button>
          </div>
          <div id="qfFloorOptions"></div>
        </div>
      </div>
      <div class="dropdown" id="xfFloorDropdown" style="width:160px;">
        <button type="button" class="dropdown-btn" id="xfFloorDropdownBtn">现房楼层：不限</button>
        <div class="dropdown-menu" id="xfFloorDropdownMenu" style="display:none;">
          <div class="xf-actions">
            <button type="button" class="btn" id="xfFloorSelectAll">全选</button>
            <button type="button" class="btn secondary" id="xfFloorClearAll">清空</button>
          </div>
          <div id="xfFloorOptions"></div>
        </div>
      </div>
      <button type="button" class="btn" id="filterClear">清空筛选</button>
    </div>
    <div id="results" class="results">尚未计算</div>
  </div>

  <div class="card">
    <div class="muted">说明</div>
    <ul class="muted">
      <li>类型标记：期房显示 A/B/C + “(期房)”并追加 幢号/门牌号/室号（若有），如“A(期房) 1幢 29号 101室”；现房显示为对应小区名称+幢号+门牌号+室号，如“(银香苑 1幢 29号 101室)”。</li>
      <li>字段含义：“兑换面积”（组合总面积）、“目标面积”（输入目标）、“浪费面积”（目标面积 - 兑换面积）。</li>
      <li>服务器默认端口：http://localhost:3000 。可在 server.js 中修改。</li>
    </ul>
  </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="var s=document.createElement('script'); s.src='/vendor/xlsx.full.min.js'; document.head.appendChild(s);"></script>
  <script>
    // Runtime check: if CDN load was blocked and onerror didn’t fire, load local fallback
    if (typeof XLSX === 'undefined') {
      var s = document.createElement('script');
      s.src = '/vendor/xlsx.full.min.js';
      document.head.appendChild(s);
    }
  </script>
  <script>
    async function loadConfig() {
      try {
        const res = await fetch('/config');
        if (!res.ok) throw new Error('配置加载失败');
        const cfg = await res.json();
        document.getElementById('topK').value = cfg.topK ?? 10;
        document.getElementById('source').value = (cfg.source ?? 'AB').toUpperCase();
        document.getElementById('minArea').value = (cfg.minArea ?? '');
        document.getElementById('maxArea').value = (cfg.maxArea ?? '');

        const policy = cfg.policy || {};
        const badge = document.getElementById('cfg-badge');
        const polText = policy.disallowDominantWithSmallOthers
          ? `策略启用：> ${policy.dominantMoreThan} 且其余 < ${policy.othersLessThan} 组合剔除`
          : '策略关闭';
        badge.textContent = `默认 topK=${cfg.topK ?? 10}，${polText}`;
      } catch (e) {
        document.getElementById('cfg-badge').textContent = '配置加载失败';
      }
    }

    function buildQuery(params) {
      const sp = new URLSearchParams();
      Object.entries(params).forEach(([k, v]) => {
        if (v === undefined || v === null || v === '') return;
        if (Array.isArray(v)) {
          v.forEach((item) => {
            if (item !== undefined && item !== null && item !== '') sp.append(k, item);
          });
        } else {
          sp.set(k, v);
        }
      });
      return sp.toString();
    }

    // 现房小区多选下拉逻辑
    function getXfSelected() {
      const boxes = Array.from(document.querySelectorAll('#xfOptions input[type="checkbox"]:checked'));
      return boxes.map(b => b.value);
    }
    function setAllXfSelected(flag) {
      const boxes = Array.from(document.querySelectorAll('#xfOptions input[type="checkbox"]'));
      boxes.forEach(b => { b.checked = !!flag; });
      updateXfBtnLabel();
    }
    function updateXfBtnLabel() {
      const btn = document.getElementById('xfDropdownBtn');
      if (!btn) return;
      const sel = getXfSelected();
      if (sel.length === 0) {
        btn.textContent = '全部现房';
      } else if (sel.length <= 2) {
        btn.textContent = sel.join('、');
      } else {
        btn.textContent = `已选 ${sel.length} 个小区`;
      }
    }
    function setupXfDropdown() {
      const btn = document.getElementById('xfDropdownBtn');
      const menu = document.getElementById('xfDropdownMenu');
      const selectAll = document.getElementById('xfSelectAll');
      const clearAll = document.getElementById('xfClearAll');
      if (!btn || !menu) return;

      btn.addEventListener('click', () => {
        menu.style.display = menu.style.display === 'none' ? '' : 'none';
      });
      document.addEventListener('click', (e) => {
        const dd = document.getElementById('xfDropdown');
        if (!dd) return;
        if (!dd.contains(e.target)) {
          menu.style.display = 'none';
        }
      });
      selectAll?.addEventListener('click', () => setAllXfSelected(true));
      clearAll?.addEventListener('click', () => setAllXfSelected(false));
      // 监听选项变化更新按钮文案
      document.getElementById('xfOptions')?.addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateXfBtnLabel();
        }
      });
    }

    function renderTable(data) {
      if (!Array.isArray(data) || data.length === 0) {
        return '<div class="muted">无结果</div>';
      }
      // 纵向：按每套组合的“最大单套面积”从大到小排序
      function rowMax(row) {
        const items = Array.isArray(row.result) ? row.result.filter(Boolean) : [];
        if (items.length === 0) return -Infinity;
        return Math.max(...items.map(it => Number(it[0]) || 0));
      }
      data = [...data].sort((a, b) => {
        const maxA = rowMax(a);
        const maxB = rowMax(b);
        return maxB - maxA;
      });
      const rows = data.map((row, idx) => {
        // 每行横向按面积从大到小，无论期房/现房
        const items = Array.isArray(row.result) ? row.result.filter(Boolean) : [];
        const ordered = items.slice().sort((a, b) => Number(b[0]) - Number(a[0]));
        const cells = Array(4).fill('').map((_, i) => {
          const item = ordered[i];
          return item ? `${item[0]} ${item[1]}` : '';
        });
        const exchange = row["兑换面积"];
        const target = row["目标面积"];
        const gap = row["浪费面积"];
        return `<tr>
          <td>${idx + 1}</td>
          <td>${cells[0]}</td>
          <td>${cells[1]}</td>
          <td>${cells[2]}</td>
          <td>${cells[3]}</td>
          <td>${exchange}</td>
          <td>${target}</td>
          <td>${gap}</td>
        </tr>`;
      }).join('');
      return `<table>
        <thead>
          <tr>
            <th class="sortable" data-sort="index">#</th>
            <th>房1</th>
            <th>房2</th>
            <th>房3</th>
            <th>房4</th>
            <th class="sortable" data-sort="exchange">兑换面积</th>
            <th class="sortable" data-sort="target">目标面积</th>
            <th class="sortable" data-sort="gap">浪费面积</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    function sortTableBy(key, dir) {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const idxMap = { index: 0, exchange: 5, target: 6, gap: 7 };
      const colIndex = idxMap[key];
      if (colIndex === undefined) return;
      rows.sort((r1, r2) => {
        const t1 = r1.children[colIndex]?.textContent.trim() || '';
        const t2 = r2.children[colIndex]?.textContent.trim() || '';
        let v1, v2;
        if (key === 'index') {
          v1 = parseInt(t1, 10) || 0;
          v2 = parseInt(t2, 10) || 0;
        } else {
          v1 = parseFloat(t1) || 0;
          v2 = parseFloat(t2) || 0;
        }
        return dir === 'asc' ? (v1 - v2) : (v2 - v1);
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    function buildFloorFilterOptions() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');

      const qfCont = document.getElementById('qfFloorOptions');
      const xfCont = document.getElementById('xfFloorOptions');
      const qfBtn = document.getElementById('qfFloorDropdownBtn');
      const xfBtn = document.getElementById('xfFloorDropdownBtn');

      if (qfCont) qfCont.innerHTML = '';
      if (xfCont) xfCont.innerHTML = '';

      if (!table) {
        if (qfBtn) qfBtn.textContent = '期房楼层：不限';
        if (xfBtn) xfBtn.textContent = '现房楼层：不限';
        return;
      }

      const qfSet = new Set();
      const xfSet = new Set();
      const trs = Array.from(table.querySelectorAll('tbody tr'));
      trs.forEach(tr => {
        for (let i = 1; i <= 4; i++) {
          const text = tr.children[i]?.textContent || '';
          const m = text.match(/(\d+)\s*室/);
          if (!m) continue;
          const roomNum = parseInt(m[1], 10);
          if (!Number.isFinite(roomNum)) continue;
          const floor = Math.floor(roomNum / 100);
          if (floor <= 0) continue;
          if (text.includes('(期房)')) {
            qfSet.add(floor);
          } else if (/\([^)]+\)/.test(text)) {
            // 现房标签显示为括号包含小区名称
            xfSet.add(floor);
          }
        }
      });

      const qFloors = Array.from(qfSet).sort((a, b) => a - b);
      const xFloors = Array.from(xfSet).sort((a, b) => a - b);

      const makeOptionRow = (idPrefix, value) => {
        const id = idPrefix + '_' + value;
        const row = document.createElement('div');
        row.className = 'xf-option';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.value = String(value);
        const lab = document.createElement('label');
        lab.setAttribute('for', id);
        lab.textContent = String(value);
        row.appendChild(cb);
        row.appendChild(lab);
        return row;
      };

      if (qfCont) {
        qFloors.forEach(f => qfCont.appendChild(makeOptionRow('qfFloor', f)));
      }
      if (xfCont) {
        xFloors.forEach(f => xfCont.appendChild(makeOptionRow('xfFloor', f)));
      }

      // 下拉开关与外部点击关闭
      const qfDD = document.getElementById('qfFloorDropdown');
      const qfMenu = document.getElementById('qfFloorDropdownMenu');
      const xfDD = document.getElementById('xfFloorDropdown');
      const xfMenu = document.getElementById('xfFloorDropdownMenu');

      if (qfBtn) qfBtn.onclick = () => { if (qfMenu) qfMenu.style.display = qfMenu.style.display === 'none' ? '' : 'none'; };
      if (xfBtn) xfBtn.onclick = () => { if (xfMenu) xfMenu.style.display = xfMenu.style.display === 'none' ? '' : 'none'; };

      document.addEventListener('click', (e) => {
        if (qfDD && !qfDD.contains(e.target)) { if (qfMenu) qfMenu.style.display = 'none'; }
        if (xfDD && !xfDD.contains(e.target)) { if (xfMenu) xfMenu.style.display = 'none'; }
      });

      // 全选/清空按钮
      const qfSelectAll = document.getElementById('qfFloorSelectAll');
      const qfClearAll = document.getElementById('qfFloorClearAll');
      const xfSelectAll = document.getElementById('xfFloorSelectAll');
      const xfClearAll = document.getElementById('xfFloorClearAll');

      function updateFloorBtnLabel() {
        const qSel = Array.from(document.querySelectorAll('#qfFloorOptions input[type="checkbox"]:checked')).map(b => b.value);
        const xSel = Array.from(document.querySelectorAll('#xfFloorOptions input[type="checkbox"]:checked')).map(b => b.value);
        if (qfBtn) qfBtn.textContent = qSel.length ? ('期房楼层：' + qSel.join('、')) : '期房楼层：不限';
        if (xfBtn) xfBtn.textContent = xSel.length ? ('现房楼层：' + xSel.join('、')) : '现房楼层：不限';
      }

      function setAllFloorSelected(containerSelector, flag) {
        const boxes = Array.from(document.querySelectorAll(containerSelector + ' input[type="checkbox"]'));
        boxes.forEach(b => { b.checked = !!flag; });
        updateFloorBtnLabel();
        applyFilter();
      }

      if (qfSelectAll) qfSelectAll.onclick = () => setAllFloorSelected('#qfFloorOptions', true);
      if (qfClearAll) qfClearAll.onclick = () => setAllFloorSelected('#qfFloorOptions', false);
      if (xfSelectAll) xfSelectAll.onclick = () => setAllFloorSelected('#xfFloorOptions', true);
      if (xfClearAll) xfClearAll.onclick = () => setAllFloorSelected('#xfFloorOptions', false);

      // 监听选项变化：更新按钮文案并应用筛选
      document.getElementById('qfFloorOptions')?.addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateFloorBtnLabel();
          applyFilter();
        }
      });
      document.getElementById('xfFloorOptions')?.addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"]')) {
          updateFloorBtnLabel();
          applyFilter();
        }
      });

      updateFloorBtnLabel();
    }

    function applyFilter() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      const countEl = document.getElementById('count');
      if (!table) {
        countEl.textContent = '';
        return;
      }
      const keyword = document.getElementById('filterText').value.trim();
      const mode = document.getElementById('filterMode').value || 'include';
      const struct = (document.getElementById('structureFilter')?.value) || 'none';
      const qSel = (document.getElementById('qfCountFilter')?.value) || 'any';
      const xSel = (document.getElementById('xfCountFilter')?.value) || 'any';
      const qFloorSel = Array.from(document.querySelectorAll('#qfFloorOptions input[type="checkbox"]:checked'))
        .map(cb => Number(cb.value)).filter(n => Number.isFinite(n));
      const xfFloorSel = Array.from(document.querySelectorAll('#xfFloorOptions input[type="checkbox"]:checked'))
        .map(cb => Number(cb.value)).filter(n => Number.isFinite(n));

      function categorizeArea(a) {
        if (!Number.isFinite(a)) return '空';
        if (a > 100) return '大';
        if (a > 70 && a < 100) return '中';
        if (a < 70) return '小';
        return '边界';
      }

      function matchesStructurePattern(cats, patternKey) {
        // 仅统计非空类别
        const present = cats.filter(c => c !== '空');
        const count = present.length;
        const cnt = { '大': 0, '中': 0, '小': 0 };
        present.forEach(c => { if (cnt[c] !== undefined) cnt[c]++; });

        if (patternKey === 'LMM') {
          // 大+中+中（恰好 3 项：1 大 2 中）
          return count === 3 && cnt['大'] === 1 && cnt['中'] === 2 && cnt['小'] === 0;
        }
        if (patternKey === 'LLS') {
          // 大+大+小（恰好 3 项：2 大 1 小）
          return count === 3 && cnt['大'] === 2 && cnt['小'] === 1 && cnt['中'] === 0;
        }
        if (patternKey === 'MMMS') {
          // 中+中+中+小（恰好 4 项：3 中 1 小）
          return count === 4 && cnt['中'] === 3 && cnt['小'] === 1 && cnt['大'] === 0;
        }
        if (patternKey === 'MMSS') {
          // 中+中+小+小（恰好 4 项：2 中 2 小）
          return count === 4 && cnt['中'] === 2 && cnt['小'] === 2 && cnt['大'] === 0;
        }
        return true; // 'none' 或未知键：不过滤
      }

      const rows = Array.from(table.querySelectorAll('tbody tr'));
      let visibleCount = 0;
      rows.forEach(tr => {
        // 文本筛选（房1~房4）
        const text = [1, 2, 3, 4].map(i => tr.children[i]?.textContent || '').join(' ');
        const has = keyword ? text.includes(keyword) : true;
        const showKeyword = keyword ? (mode === 'include' ? has : !has) : true;

        // 结构筛选：解析面积并分类
        const nums = [1, 2, 3, 4].map(i => parseFloat(tr.children[i]?.textContent || '')).filter(n => Number.isFinite(n));
        const cats = nums.map(categorizeArea);
        const showStruct = struct === 'none' ? true : matchesStructurePattern(cats, struct);
        // 统计当前行期房/现房数量
        const counts = [1, 2, 3, 4].reduce((acc, i) => {
          const t = tr.children[i]?.textContent || '';
          if (t.includes('(期房)')) {
            acc.q++;
          } else if (/\([^)]+\)/.test(t)) {
            // 现房标签现在显示为小区名称括号，如 "(银香苑)"
            acc.x++;
          }
          return acc;
        }, { q: 0, x: 0 });
        const showQ = qSel === 'any' ? true : counts.q === Number(qSel);
        const showX = xSel === 'any' ? true : counts.x === Number(xSel);

        // 楼层筛选（多选）：分别提取期房与现房楼层，任一命中所选集合即可
        const qFloors = [];
        const xFloors = [];
        for (let i = 1; i <= 4; i++) {
          const t = tr.children[i]?.textContent || '';
          const m = t.match(/(\d+)\s*室/);
          if (!m) continue;
          const roomNum = parseInt(m[1], 10);
          if (!Number.isFinite(roomNum)) continue;
          const floor = Math.floor(roomNum / 100);
          if (floor <= 0) continue;
          if (t.includes('(期房)')) {
            qFloors.push(floor);
          } else if (/\([^)]+\)/.test(t)) {
            xFloors.push(floor);
          }
        }
        const showQF = qFloorSel.length === 0 ? true : qFloors.some(f => qFloorSel.includes(f));
        const showXF = xfFloorSel.length === 0 ? true : xFloors.some(f => xfFloorSel.includes(f));
        const showF = showQF && showXF;

        const show = showKeyword && showStruct && showQ && showX && showF;
        tr.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });
      countEl.textContent = '共 ' + visibleCount + ' 条结果';
    }

    function bindTableEnhancements() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      if (!table) return;
      const headers = table.querySelectorAll('thead th[data-sort]');
      headers.forEach(th => {
        const key = th.getAttribute('data-sort');
        th.addEventListener('click', () => {
          if (window.__sortKey === key) {
            window.__sortDir = window.__sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            window.__sortKey = key;
            window.__sortDir = key === 'index' ? 'asc' : 'desc';
          }
          sortTableBy(window.__sortKey, window.__sortDir);
        });
      });
    }

    async function onSubmit(e) {
      e.preventDefault();
      const msg = document.getElementById('msg');
      const resultsEl = document.getElementById('results');
      const countEl = document.getElementById('count');
      msg.textContent = '';
      countEl.textContent = '';

      const target = document.getElementById('target').value;
      const topK = document.getElementById('topK').value;
      const source = document.getElementById('source').value;
      const minArea = document.getElementById('minArea').value;
      const maxArea = document.getElementById('maxArea').value;
      const xfSel = getXfSelected();

      const qs = buildQuery({
        target, topK, source,
        minArea, maxArea,
        xfCommunities: xfSel
      });

      try {
        setLoading(true);
        resultsEl.textContent = '计算中...';
        const res = await fetch('/solve?' + qs);
        const data = await res.json();
        if (!res.ok) {
          resultsEl.innerHTML = '<span class="error">' + (data.error || '请求失败') + '</span>';
          setLoading(false);
          return;
        }
        resultsEl.innerHTML = renderTable(data);
        bindTableEnhancements();
        buildFloorFilterOptions();
        applyFilter();
        updateExportButtonState();
        setLoading(false);
      } catch (err) {
        resultsEl.innerHTML = '<span class="error">' + err.message + '</span>';
        setLoading(false);
      }
    }

    function updateExportButtonState() {
      const btn = document.getElementById('btn-export-table');
      if (!btn) return;
      const table = document.getElementById('results').querySelector('table');
      btn.disabled = !table;
    }

    function setLoading(flag) {
      const ov = document.getElementById('loadingOverlay');
      const solveBtn = document.getElementById('btn-solve');
      if (ov) ov.style.display = flag ? 'flex' : 'none';
      if (solveBtn) solveBtn.disabled = !!flag;
    }

    function exportFilteredTableToExcel() {
      const resultsEl = document.getElementById('results');
      const table = resultsEl.querySelector('table');
      const msg = document.getElementById('msg');
      if (!table) {
        if (msg) msg.textContent = '无表格可导出，请先计算';
        return;
      }
      // 若前端 XLSX 库未加载（可能被网络限制），回退到服务端导出
      if (typeof XLSX === 'undefined') {
        if (msg) msg.textContent = '前端 XLSX 库未加载，正在使用服务端导出…';
        // 从表单取当前参数，构建服务端导出请求
        const target = document.getElementById('target').value;
        const topK = document.getElementById('topK').value;
        const source = document.getElementById('source').value;
        const minArea = document.getElementById('minArea').value;
        const maxArea = document.getElementById('maxArea').value;
        const xfSel = getXfSelected();
        const qs = buildQuery({
          target, topK, source,
          minArea, maxArea,
          xfCommunities: xfSel
        });
        // 跳转到服务端 /excel 下载
        window.location.href = '/excel?' + qs;
        return;
      }
      // 采集表头
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      // 采集可见行数据
      const rows = [];
      const trs = Array.from(table.querySelectorAll('tbody tr'));
      trs.forEach(tr => {
        if (tr.style.display === 'none') return;
        const row = Array.from(tr.children).map(td => (td.textContent || '').trim());
        rows.push(row);
      });
      if (rows.length === 0) {
        if (msg) msg.textContent = '当前筛选无可导出的行';
        return;
      }
      const aoa = [headers, ...rows];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '筛选结果');
      const targetVal = (document.getElementById('target')?.value || '').trim();
      const fname = targetVal ? ('results-' + targetVal + '.xlsx') : 'results.xlsx';
      XLSX.writeFile(wb, fname);
    }

    document.getElementById('solve-form').addEventListener('submit', onSubmit);
    document.getElementById('btn-export-table').addEventListener('click', exportFilteredTableToExcel);
    // 过滤控件事件绑定
    document.getElementById('filterText').addEventListener('input', applyFilter);
    document.getElementById('filterMode').addEventListener('change', applyFilter);
    document.getElementById('structureFilter').addEventListener('change', applyFilter);
    document.getElementById('qfCountFilter')?.addEventListener('change', applyFilter);
    document.getElementById('xfCountFilter')?.addEventListener('change', applyFilter);
    document.getElementById('filterClear').addEventListener('click', () => {
      const input = document.getElementById('filterText');
      input.value = '';
      const qSel = document.getElementById('qfCountFilter');
      const xSel = document.getElementById('xfCountFilter');
      if (qSel) qSel.value = 'any';
      if (xSel) xSel.value = 'any';
      // 清空楼层多选（期房/现房）
      const qfBoxes = Array.from(document.querySelectorAll('#qfFloorOptions input[type="checkbox"]'));
      qfBoxes.forEach(b => { b.checked = false; });
      const xfBoxes = Array.from(document.querySelectorAll('#xfFloorOptions input[type="checkbox"]'));
      xfBoxes.forEach(b => { b.checked = false; });
      const qfBtn = document.getElementById('qfFloorDropdownBtn');
      if (qfBtn) qfBtn.textContent = '期房楼层：不限';
      const xfBtn = document.getElementById('xfFloorDropdownBtn');
      if (xfBtn) xfBtn.textContent = '现房楼层：不限';
      applyFilter();
    });
    loadConfig();
    (async function loadCommunities() {
      try {
        const res = await fetch('/communities?type=xf');
        if (!res.ok) throw new Error('小区列表加载失败');
        const list = await res.json();
        const cont = document.getElementById('xfOptions');
        if (cont && Array.isArray(list)) {
          cont.innerHTML = '';
          const defaults = new Set(['辰香苑','银香苑','景华新苑']);
          list.forEach((name, idx) => {
            const id = 'xfopt_' + idx;
            const row = document.createElement('div');
            row.className = 'xf-option';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.id = id;
            cb.value = name;
            cb.checked = defaults.has(name);
            const lab = document.createElement('label');
            lab.setAttribute('for', id);
            lab.textContent = name;
            row.appendChild(cb);
            row.appendChild(lab);
            cont.appendChild(row);
          });
          setupXfDropdown();
          updateXfBtnLabel();
        }
      } catch (e) {
        // ignore
      }
    })();
  </script>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="panel">
      <div class="spinner"></div>
      <div>计算中，请稍候…</div>
    </div>
  </div>
</body>

</html>
