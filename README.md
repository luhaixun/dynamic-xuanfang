# 上海市闵行区梅陇镇城中村 选房程序（内部版）

这是一个使用 Node.js 编写的小工具，用于从两个 Excel 数据源（期房 / 现房）中，
计算总面积不超过目标值（≤ target）且最接近目标值的 Top-K 组合方案。数据在启动时一次性从 Excel 读入并保存在内存中，保留全部字段（不丢弃任何列）。

本项目同时提供：
- Web UI（前端筛选、交互式查看与导出）

---

## 核心规则

- 结果条数只能是 3 套或 4 套
- 未启用赠送面积：户型必须覆盖 A / B / C（各至少 1 套）
- 启用赠送面积（通过查询/参数 `giftArea` > 0）：求解器在候选类型中以 `D`（赠送类）替代 `C` 作为第三位候选，组合要求至少包含 `A` 与 `B` 且至少存在 `D` 可选条目；同时会在最终结果中过滤掉浪费面积（目标 - 兑换面积）大于等于赠送面积的方案（只保留浪费面积 < `giftArea`）。
- 4 套时，只允许某一类重复一次（如 A×2、B×1、C×1 或在启用赠送时允许 A×2+B+D 等形式——重复一类且其余两类各 1 套）
- 总面积 ≤ target，且尽量接近 target
- 至少 1 套必须来自“现房”数据源（B）
- 后端硬约束：不允许出现“两套‘大’（面积 > 100）且均来自期房（A）”的组合
- 返回最优的前 K 条结果（K 可配置）


策略（可在 `config.json` 启用）：
- `disallowDominantWithSmallOthers`：不允许“恰好 1 条面积 > `dominantMoreThan`，且其余所有条目面积 < `othersLessThan`”的组合。当前仓库 `config.json` 中的默认阈值为 `dominantMoreThan=135`、`othersLessThan=60`。

说明：启用赠送面积时，请通过查询参数或调用 `solveTopK` 时传入 `giftArea`（数值）来指定赠送面积阈值；当 `giftArea > 0` 时，求解器会把候选集合中的类型选择为 `A`/`B`/`D`（而非 `A`/`B`/`C`），并在返回结果前排除浪费面积 ≥ `giftArea` 的组合。

---

## 数据来源

- 期房：data/期房-汇总.xlsx，工作表名“期房汇总”
- 现房：data/现房-汇总.xlsx，工作表名“现房汇总”
- 第一行是表头，所有列会被完整保留（包括空值）

重要列约定：
- 面积列统一使用“建筑面积”参与计算与过滤
- 类型列：
  - 期房使用“类别”（值如 A、B、C 或 A类/B类/C类）
  - 现房使用“类型”（值如 A、B、C 或 A类/B类/C类）

示例表头（实际 Excel 里可能更多列，都会保留）：
- 期房：序号、房源类型、幢号、门牌号、室号、户型、建筑面积、单价、类别
- 现房：序号、房源型、小区名称、幢号、室号、户型、建筑面积、单价、类型

---

## 文件结构

```text
project/
├── server.js            # Web UI 与 API
├── config.json          # 默认配置（topK/source/导出/过滤策略等）
├── data/
│   ├── 期房-汇总.xlsx   # 期房数据（工作表：期房汇总）
│   └── 现房-汇总.xlsx   # 现房数据（工作表：现房汇总）
├── public/
│   └── index.html       # 前端页面与交互逻辑（筛选、导出、Overlay）
└── src/
    ├── data.js          # 启动时一次性加载 Excel，保留所有列
    ├── solver.js        # 核心组合搜索与 TopK（含约束校验）
    ├── export.js        # 结果导出到 Excel
    ├── normalize.js     # 类型归一化（A/B/C/D 与 A类/B类/C类/D类）
    ├── bisect.js        # 二分查找工具
    ├── topk.js          # TopK 容器与去重
    └── cli.js           # 命令行入口（内部开发用，不对外提供）
```

---

## 配置文件与覆盖策略

- 配置文件：根目录下的 config.json，包含默认值：
  ```json
  {
    "topK": 30000,
    "source": "AB",
    "fileAPath": "./data/期房-汇总.json",
    "fileBPath": "./data/现房-汇总.json",
    "excel": "./output.xlsx",
    "minArea": 50,
    "targetPresets": [318.64, 312.64],
    "policy": {
      "disallowDominantWithSmallOthers": true,
      "dominantMoreThan": 135,
      "othersLessThan": 60
    }
  }
  ```
- 覆盖优先级（从高到低）：
  1) 服务端查询参数（/solve 接口的 Query：topK / source / minArea / maxArea）
  2) config.json 默认值（若未传入则采用）

---

## Web UI 与前端筛选

启动服务：
```bash
node server.js
# 浏览器访问：http://localhost:3000
```

页面功能：
- 表格排序
  - 纵向：每套组合按“最大单套面积”降序排列
  - 横向：每行的房1~房4按面积降序排列
- 套型组合（结构筛选重命名）
  - 下拉：套型组合（原“结构筛选”）
  - 选项：大+中+中（LMM）、大+大+小（LLS）、中+中+中+小（MMMS）、中+中+小+小（MMSS）、不限
  - 分类阈值：大（>100）、中（70< a <100）、小（<70），边界值（=70 或 =100）归为“边界”，不参与上述三类计数
- 现房小区（多选）
  - 默认勾选：“辰香苑”“银香苑”“景华新苑”（若存在于列表）
  - 下拉按钮文案随选择项更新，≥3 项显示“已选 N 个小区”
- 楼层筛选（多选）
  - 分为“期房楼层”（多选）与“现房楼层”（多选）两个独立下拉
  - 从表格动态生成可选楼层；规则：楼层 = 室号除以 100 的整数部分（如 1101 → 11）
  - 逻辑：若对应下拉有选择，则该来源（期房/现房）至少命中一个所选楼层；两个来源条件需同时满足；若某来源未选择则视为不限
- 期房数量 / 现房数量筛选
  - 分别筛选每行组合中期房/现房的套数（0~4 或不限）
- 计算中遮罩（Overlay）
  - 发起计算时显示全屏遮罩“计算中，请稍候…”，并禁用“计算”按钮，防止误操作；完成或失败后自动隐藏
- 导出到 Excel
  - 前端导出：文件名采用目标面积命名，格式为 `results-{target}.xlsx`，若目标为空则为 `results.xlsx`
  - 服务端导出（回退方案）：/excel 接口的响应头 filename 同样使用目标面积命名

---

## API 说明（服务端）

- GET `/`：返回前端页面（public/index.html）
- GET `/config`：返回当前配置
- GET `/solve?target=...&topK=...&source=...&minArea=...&maxArea=...&xfCommunities=...`：根据查询参数计算并返回 JSON 结果
- GET `/excel?target=...`：根据查询参数计算并返回 Excel 文件下载（文件名：results-{target}.xlsx）
- GET `/communities?type=xf`：返回现房小区列表（自动检测列名，如“小区名称/项目名称/楼盘名称”等）

---

## 输出示例

```js
{
  result: [
    [62.65, "A(期房) 1幢 29号 101室"],
    [64.35, "A(期房) 1幢 29号 102室"],
    [63.06, "(银香苑 1幢 29号 101室)"],
    [128.57, "(景华新苑 2幢 19号 1101室)"]
  ],
  "兑换面积": 318.63,
  "目标面积": 318.64,
  "浪费面积": 0.01
}
```

- 兑换面积：组合总面积
- 浪费面积：目标面积 - 兑换面积（越小越好）

---

## 错误与校验

- 若工作表不存在或为空，会抛出明确错误（例如：Excel 工作表不存在或无数据）。
- 若必需列缺失（如“建筑面积”、类型列），会抛出错误提示。
- 所有表头列都会被完整保留在内存数据结构中（以备扩展使用）。

---

## JSON 缓存与 --refresh

为提升启动速度，程序在首次解析 Excel 后会生成同目录的 JSON 缓存：
- 期房缓存：data/期房-汇总.json
- 现房缓存：data/现房-汇总.json

后续启动时，将优先从 JSON 缓存加载数据；仅在以下情况下重新解析 Excel 并覆盖缓存：
- 首次运行（JSON 缓存不存在）
- 显式传入 `--refresh` 标志（强制刷新）

说明：
- `--refresh` 适用于服务端：
  - 服务端示例：`node server.js --refresh`
- 无论从 Excel 还是缓存 JSON 加载，都会进行表头校验：必须包含“建筑面积”与类型列（期房“类别”、现房“类型”）；缺失时会抛出错误。

仅刷新缓存（不启动服务）示例：
```bash
# 解析 Excel 并写入 JSON 缓存
node -e "require('./src/data')"

# 强制刷新（忽略现有 JSON）
node -e "process.argv.push('--refresh'); require('./src/data')"
```

---

## 运行环境

- Node.js ≥ 16

---

## 变更日志（近期）

- 新增“套型组合”筛选（原“结构筛选”重命名），新增模式：大+大+小（LLS）
- 新增期房/现房楼层两个独立多选筛选，下拉选项从表格动态生成；命中任一所选楼层即可
- 现房小区多选默认勾选：辰香苑、银香苑、景华新苑（若列表存在）
- 增加“计算中”全屏遮罩，计算期间禁用交互，防误操作
- 导出到 Excel 的文件名使用目标面积命名：results-{target}.xlsx（前端与服务端一致）
- 后端新增硬约束：不允许两套“大”（>100）均来自期房的组合入榜
